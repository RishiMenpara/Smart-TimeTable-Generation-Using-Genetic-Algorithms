<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Timetable Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      margin: 0;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: #333;
      min-height: 100vh;
    }

    h1,
    h2,
    h3 {
      margin-top: 0;
    }

    .container {
      max-width: 1100px;
      margin: auto;
      padding: 20px;
    }

    /* Header */
    .header {
      text-align: center;
      padding: 35px 15px;
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      color: white;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .header p {
      opacity: 0.9;
      font-size: 14px;
    }

    /* Sections */
    .section {
      background: white;
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      border-left: 4px solid #2563eb;
    }

    .section-title {
      margin-bottom: 20px;
      font-size: 18px;
      font-weight: 600;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title::before {
      content: '';
      display: inline-block;
      width: 4px;
      height: 20px;
      background: #2563eb;
      border-radius: 2px;
    }

    /* Form Layout */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    label {
      font-size: 13px;
      color: #555;
      font-weight: 500;
      display: block;
      margin-bottom: 6px;
    }

    input,
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .card {
      border: 1px solid #e5e7eb;
      padding: 18px;
      border-radius: 8px;
      background: #fafafa;
      margin-bottom: 15px;
      transition: box-shadow 0.3s;
    }

    .card:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    button {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-add {
      background: #2563eb;
      color: white;
      margin-top: 10px;
    }

    .btn-add:hover:not(:disabled) {
      background: #1d4ed8;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
    }

    .btn-generate {
      background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
      color: white;
      width: 100%;
      font-size: 16px;
      padding: 14px;
      font-weight: 700;
    }

    .btn-generate:hover:not(:disabled) {
      background: linear-gradient(135deg, #15803d 0%, #127435 100%);
      box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
    }

    .btn-secondary {
      background: #64748b;
      color: white;
      margin-right: 10px;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #475569;
    }

    .btn-remove {
      background: #ef4444;
      color: white;
      padding: 6px 12px;
      font-size: 12px;
      margin-top: 10px;
    }

    .btn-remove:hover:not(:disabled) {
      background: #dc2626;
    }

    /* Checkbox group */
    .checkbox-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 0;
      cursor: pointer;
      font-weight: 400;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin: 0;
      cursor: pointer;
    }

    /* Time Slots Section */
    .time-slots-container {
      background: #f8fafc;
      padding: 20px;
      border-radius: 8px;
      margin-top: 15px;
    }

    .time-slot-group {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .time-slot-group:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    /* Timetable */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
      font-size: 13px;
    }

    th {
      background: #f1f5f9;
      font-weight: 600;
      color: #334155;
    }

    tr:nth-child(even) {
      background: #fafafa;
    }

    .output-actions {
      margin-top: 20px;
      text-align: right;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    footer {
      text-align: center;
      font-size: 13px;
      color: #666;
      margin: 40px 0 10px;
    }

    .sub-card {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .sub-card-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 8px;
    }

    /* Loading indicator */
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      background: #f0f9ff;
      border-radius: 8px;
      margin: 20px 0;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 4px solid #f0f0f0;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Alert messages */
    .alert {
      padding: 12px 16px;
      margin: 15px 0;
      border-radius: 6px;
      display: none;
    }

    .alert.active {
      display: block;
    }

    .alert-success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #86efac;
    }

    .alert-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }

    .alert-info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
    }

    /* Output section */
    #outputSection {
      display: none;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .stat-card {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-card h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      opacity: 0.9;
    }

    .stat-card .value {
      font-size: 28px;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üìö Timetable Generator</h1>
      <p>Create conflict-free class schedules using Genetic Algorithms</p>
    </div>



    <!-- Standards Section -->
    <div class="section">
      <div class="section-title">Academic Standards & Courses</div>
      <div id="standardsContainer"></div>
      <button class="btn-add" onclick="addStandard()">+ Add Standard</button>
    </div>

    <!-- Faculty Section -->
    <div class="section">
      <div class="section-title">Faculty Members</div>
      <div id="facultyContainer"></div>
      <button class="btn-add" onclick="addFaculty()">+ Add Faculty</button>
    </div>

    <!-- Classrooms Section -->
    <div class="section">
      <div class="section-title">Classrooms</div>
      <div id="roomContainer"></div>
      <button class="btn-add" onclick="addRoom()">+ Add Classroom</button>
    </div>

    <!-- Time Slots Section -->
    <div class="section">
      <div class="section-title">Time Slots (in 15-minute intervals)</div>
      <div class="time-slots-container">
        <div id="timeSlots"></div>
        <button class="btn-add" onclick="addTimeSlot()">+ Add Time Slot</button>
      </div>
    </div>

    <!-- Days of Week Section -->
    <div class="section">
      <div class="section-title">Days of Week</div>
      <div class="checkbox-group" id="daysCheckboxes">
        <label><input type="checkbox" value="Monday" onchange="updateDays()"> Monday</label>
        <label><input type="checkbox" value="Tuesday" onchange="updateDays()"> Tuesday</label>
        <label><input type="checkbox" value="Wednesday" onchange="updateDays()"> Wednesday</label>
        <label><input type="checkbox" value="Thursday" onchange="updateDays()"> Thursday</label>
        <label><input type="checkbox" value="Friday" onchange="updateDays()"> Friday</label>
        <label><input type="checkbox" value="Saturday" onchange="updateDays()"> Saturday</label>
        <label><input type="checkbox" value="Sunday" onchange="updateDays()"> Sunday</label>
      </div>
    </div>

    <!-- Course Assignments Section -->
    <div class="section">
      <div class="section-title">Course Assignments</div>
      <div id="assignmentContainer"></div>
      <button class="btn-add" onclick="addAssignment()">+ Add Assignment</button>
    </div>

    <!-- Constraints Section -->
    <div class="section">
      <div class="section-title">Custom Constraints</div>

      <!-- Hard Constraints -->
      <div style="margin-bottom: 25px;">
        <h3 style="margin-top: 0; color: #dc2626; font-size: 16px;">üî¥ Hard Constraints (Must be satisfied)</h3>
        <p style="font-size: 13px; color: #666; margin-top: 0;">If not satisfied, timetable is invalid</p>
        <div id="hardConstraintsContainer"></div>
        <button class="btn-add" onclick="addHardConstraint()">+ Add Hard Constraint</button>
      </div>

      <!-- Soft Constraints -->
      <div style="margin-bottom: 25px;">
        <h3 style="margin-top: 0; color: #16a34a; font-size: 16px;">üü¢ Soft Constraints (Preferred)</h3>
        <p style="font-size: 13px; color: #666; margin-top: 0;">If not satisfied, timetable quality is reduced but still
          valid</p>
        <div id="softConstraintsContainer"></div>
        <button class="btn-add" onclick="addSoftConstraint()">+ Add Soft Constraint</button>
      </div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer"></div>

    <!-- Generate Button -->
    <div style="text-align: center; margin: 30px 0;">
      <button class="btn-generate" onclick="generateTimetable()">üöÄ Generate Timetable</button>
    </div>

    <!-- Loading Indicator -->
    <div class="loading" id="loadingIndicator">
      <div class="spinner"></div>
      <p>Generating timetable using Genetic Algorithm...</p>
      <p id="generationCount" style="font-size: 12px; color: #666;"></p>
    </div>

    <!-- Output Section -->
    <div id="outputSection" class="section">
      <div class="section-title">‚úì Timetable Generated Successfully</div>

      <!-- Space-Time Timetable -->
      <div style="margin: 20px 0;">
        <h3>Space-Time Timetable</h3>
        <div id="previewContainer"></div>
      </div>

      <!-- Standard-wise Normal Timetables -->
      <div style="margin: 20px 0;">
        <h3>Standard-wise Timetables</h3>
        <div id="standardTimetablesContainer"></div>
      </div>

      <!-- More Details (Hidden by default) -->
      <div style="margin: 20px 0;">
        <button class="btn-secondary" onclick="toggleMoreDetails()" style="width: auto;">üìä More Details</button>
        <div id="moreDetailsSection"
          style="display: none; margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
          <div class="stats-grid">
            <div class="stat-card">
              <h3>Scheduling Conflicts</h3>
              <div class="value" id="conflictCount">0</div>
            </div>
            <div class="stat-card">
              <h3>Algorithm Fitness</h3>
              <div class="value" id="fitnessScore">0</div>
            </div>
            <div class="stat-card">
              <h3>Total Classes</h3>
              <div class="value" id="classCount">0</div>
            </div>
          </div>
        </div>
      </div>

      <div class="output-actions">
        <button class="btn-secondary" onclick="downloadExcel()">üì• Download Excel</button>
        <button class="btn-secondary" onclick="downloadAsImage()">üñºÔ∏è Download as Image</button>
        <button class="btn-secondary" onclick="resetForm()">‚ü≤ New Timetable</button>
      </div>
    </div>

    <footer>
      <p>Timetable Generator &copy; 2024 | Powered by Genetic Algorithms</p>
    </footer>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:5000';

    // Data structures
    let standards = [];
    let faculty = [];
    let assignments = [];
    let selectedDays = [];
    let timeSlots = [];
    let timeSlotsCount = 1;
    let timeSlotValues = [{ startTime: '', endTime: '' }];
    let generatedFilename = null;
    let currentScheduleData = null;
    let hardConstraints = [];
    let softConstraints = [];

    // Utility function to show alerts
    function showAlert(message, type = 'success') {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} active`;
      alert.textContent = message;
      container.appendChild(alert);

      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    // Get classroom data
    function getClassrooms() {
      const inputs = document.querySelectorAll('#roomContainer input');
      return Array.from(inputs).map(input => input.value).filter(v => v);
    }

    // Update selected days
    function updateDays() {
      const checkboxes = document.querySelectorAll('#daysCheckboxes input[type="checkbox"]');
      selectedDays = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
    }

    // Standards Management
    function addStandard() {
      const container = document.getElementById("standardsContainer");
      const standardId = 'standard-' + Date.now();
      const standardIndex = standards.length;

      standards.push({
        id: standardId,
        name: '',
        courses: []
      });

      const cardDiv = document.createElement('div');
      cardDiv.className = 'card';
      cardDiv.id = standardId;
      cardDiv.innerHTML = `
        <div>
          <label>Standard/Class Name</label>
          <input type="text" placeholder="E.g., Class 8-A, BCA-1" onchange="updateStandardName(${standardIndex}, this.value)">
        </div>
        
        <div style="margin-top: 15px;">
          <p style="margin: 0 0 10px 0; font-weight: 600; color: #1e293b;">Courses:</p>
          <div id="${standardId}-courses"></div>
          <button class="btn-add" style="margin-top: 10px;" onclick="addCourse(${standardIndex})">+ Add Course</button>
        </div>
        
        <button class="btn-remove" onclick="removeStandard('${standardId}', ${standardIndex})">Remove Standard</button>
      `;
      container.appendChild(cardDiv);
    }

    function updateStandardName(index, name) {
      standards[index].name = name;
      updateAssignmentDropdowns();
    }

    function addCourse(standardIndex) {
      const standard = standards[standardIndex];
      const courseId = 'course-' + Date.now();
      const courseIndex = standard.courses.length;

      standard.courses.push({
        id: courseId,
        name: '',
        courseCode: ''
      });

      const container = document.getElementById(`${standard.id}-courses`);
      const subCardDiv = document.createElement('div');
      subCardDiv.className = 'sub-card';
      subCardDiv.id = courseId;
      subCardDiv.innerHTML = `
        <div class="sub-card-grid">
          <div>
            <label>Course Name</label>
            <input type="text" placeholder="E.g., Mathematics" onchange="updateCourseName(${standardIndex}, ${courseIndex}, 'name', this.value)">
          </div>
          <div>
            <label>Course ID</label>
            <input type="text" placeholder="E.g., MA101" onchange="updateCourseName(${standardIndex}, ${courseIndex}, 'courseCode', this.value)">
          </div>
        </div>
        <button class="btn-remove" style="font-size: 11px; padding: 4px 8px;" onclick="removeCourse('${courseId}', ${standardIndex}, ${courseIndex})">Remove Course</button>
      `;
      container.appendChild(subCardDiv);

      updateAssignmentDropdowns();
    }

    function updateCourseName(standardIndex, courseIndex, field, value) {
      standards[standardIndex].courses[courseIndex][field] = value;
      updateAssignmentDropdowns();
    }

    function removeCourse(courseId, standardIndex, courseIndex) {
      document.getElementById(courseId).remove();
      const removedCourseId = standards[standardIndex].courses[courseIndex].id;
      standards[standardIndex].courses.splice(courseIndex, 1);

      // Clear any assignments that referenced this deleted course
      assignments.forEach(assignment => {
        if (assignment.courseId === removedCourseId) {
          assignment.courseId = '';
        }
      });

      updateAssignmentDropdowns();
    }

    function removeStandard(standardId, standardIndex) {
      if (confirm('Remove this standard and all its courses?')) {
        document.getElementById(standardId).remove();
        standards.splice(standardIndex, 1);
        updateAssignmentDropdowns();
      }
    }

    // Faculty Management
    function addFaculty() {
      const container = document.getElementById("facultyContainer");
      const facultyId = 'faculty-' + Date.now();
      const facultyIndex = faculty.length;

      faculty.push({
        id: facultyId,
        name: '',
        facultyCode: ''
      });

      const cardDiv = document.createElement('div');
      cardDiv.className = 'card';
      cardDiv.id = facultyId;
      cardDiv.innerHTML = `
        <div class="grid">
          <div>
            <label>Faculty Name</label>
            <input type="text" placeholder="E.g., Dr. Smith" onchange="updateFaculty(${facultyIndex}, 'name', this.value)">
          </div>
          <div>
            <label>Faculty ID</label>
            <input type="text" placeholder="E.g., F001" onchange="updateFaculty(${facultyIndex}, 'facultyCode', this.value)">
          </div>
        </div>
        <button class="btn-remove" onclick="removeFaculty('${facultyId}', ${facultyIndex})">Remove</button>
      `;
      container.appendChild(cardDiv);

      updateAssignmentDropdowns();
    }

    function updateFaculty(index, field, value) {
      faculty[index][field] = value;
      updateAssignmentDropdowns();
    }

    function removeFaculty(facultyId, facultyIndex) {
      document.getElementById(facultyId).remove();
      const removedFacultyId = faculty[facultyIndex].id;
      faculty.splice(facultyIndex, 1);

      // Clear any assignments that referenced this deleted faculty
      assignments.forEach(assignment => {
        if (assignment.facultyId === removedFacultyId) {
          assignment.facultyId = '';
        }
      });

      updateAssignmentDropdowns();
    }

    // Assignment Management
    function addAssignment() {
      const container = document.getElementById("assignmentContainer");
      const assignmentId = 'assignment-' + Date.now();
      const assignmentIndex = assignments.length;

      assignments.push({
        id: assignmentId,
        courseId: '',
        facultyId: '',
        timesPerWeek: 1
      });

      const cardDiv = document.createElement('div');
      cardDiv.className = 'card';
      cardDiv.id = assignmentId;
      cardDiv.innerHTML = `
        <div class="grid">
          <div>
            <label>Select Course</label>
            <select id="${assignmentId}-course" onchange="updateAssignment(${assignmentIndex}, 'courseId', this.value)">
              <option value="">-- Select Course --</option>
            </select>
          </div>
          <div>
            <label>Assign Faculty</label>
            <select id="${assignmentId}-faculty" onchange="updateAssignment(${assignmentIndex}, 'facultyId', this.value)">
              <option value="">-- Select Faculty --</option>
            </select>
          </div>
          <div>
            <label>Times per Week</label>
            <input type="number" min="1" value="1" onchange="updateAssignment(${assignmentIndex}, 'timesPerWeek', parseInt(this.value))">
          </div>
        </div>
        <button class="btn-remove" onclick="removeAssignment('${assignmentId}', ${assignmentIndex})">Remove</button>
      `;
      container.appendChild(cardDiv);

      updateAssignmentDropdowns();
    }

    function updateAssignment(index, field, value) {
      assignments[index][field] = value;
      if (field === 'courseId') {
        updateAssignmentDropdowns();
      }
    }

    function removeAssignment(assignmentId, assignmentIndex) {
      document.getElementById(assignmentId).remove();
      assignments.splice(assignmentIndex, 1);
      updateAssignmentDropdowns();
    }

    function updateAssignmentDropdowns() {
      const assignedCourseIds = assignments.map(a => a.courseId).filter(id => id);

      assignments.forEach((assignment, index) => {
        const courseSelect = document.getElementById(`${assignment.id}-course`);
        const facultySelect = document.getElementById(`${assignment.id}-faculty`);

        if (courseSelect) {
          const currentValue = courseSelect.value;
          courseSelect.innerHTML = '<option value="">-- Select Course --</option>';

          // Check if current value still exists in available courses
          let currentCourseStillExists = false;

          standards.forEach(standard => {
            standard.courses.forEach(course => {
              if (!assignedCourseIds.includes(course.id) || course.id === currentValue) {
                const displayName = `${standard.name} - ${course.name} (${course.courseCode})`;
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = displayName;
                if (course.id === currentValue) {
                  option.selected = true;
                  currentCourseStillExists = true;
                }
                courseSelect.appendChild(option);
              }
            });
          });

          // Clear the assignment if course no longer exists
          if (!currentCourseStillExists && currentValue !== '') {
            assignment.courseId = '';
          }
        }

        if (facultySelect) {
          const currentFacultyValue = facultySelect.value;
          facultySelect.innerHTML = '<option value="">-- Select Faculty --</option>';

          // Check if current value still exists in faculty list
          const currentFacultyStillExists = faculty.some(f => f.id === currentFacultyValue);

          faculty.forEach(fac => {
            const displayName = `${fac.name} (${fac.facultyCode})`;
            const option = document.createElement('option');
            option.value = fac.id;
            option.textContent = displayName;
            if (fac.id === currentFacultyValue && currentFacultyStillExists) {
              option.selected = true;
            }
            facultySelect.appendChild(option);
          });

          // Clear the assignment if faculty no longer exists
          if (!currentFacultyStillExists && currentFacultyValue !== '') {
            assignment.facultyId = '';
          }
        }
      });
    }

    // Classroom Management
    function addRoom() {
      const container = document.getElementById("roomContainer");
      const cardId = 'room-' + Date.now();

      const cardDiv = document.createElement('div');
      cardDiv.className = 'card';
      cardDiv.id = cardId;
      cardDiv.innerHTML = `
        <div class="grid">
          <div><label>Classroom ID</label><input type="text" placeholder="E.g., Room 101"></div>
        </div>
        <button class="btn-remove" onclick="removeCard('${cardId}')">Remove</button>
      `;
      container.appendChild(cardDiv);
    }

    function removeCard(cardId) {
      document.getElementById(cardId).remove();
    }

    // Time Slot Management - FIXED
    function addTimeSlot() {
      timeSlotValues.push({ startTime: '', endTime: '' });
      renderTimeSlots();
    }

    function removeTimeSlot(index) {
      if (timeSlotValues.length > 1) {
        timeSlotValues.splice(index, 1);
        renderTimeSlots();
      }
    }

    function renderTimeSlots() {
      const container = document.getElementById("timeSlots");
      let html = '';
      for (let i = 0; i < timeSlotValues.length; i++) {
        html += `
          <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: flex-end;">
            <div>
              <label>Slot ${i + 1} Start Time</label>
              <input type="time" value="${timeSlotValues[i].startTime}" onchange="timeSlotValues[${i}].startTime = this.value">
            </div>
            <div>
              <label>Slot ${i + 1} End Time</label>
              <input type="time" value="${timeSlotValues[i].endTime}" onchange="timeSlotValues[${i}].endTime = this.value">
            </div>
            ${timeSlotValues.length > 1 ? `<button class="btn-remove" style="height: 38px;" onclick="removeTimeSlot(${i})">‚àí</button>` : ''}
          </div>
        `;
      }
      container.innerHTML = html;
    }

    // Collect time slots from data array
    function collectTimeSlots() {
      return timeSlotValues.filter(slot => slot.startTime && slot.endTime);
    }

    // Hard Constraints
    function addHardConstraint() {
      const container = document.getElementById("hardConstraintsContainer");
      const constraintId = 'hard-' + Date.now();
      const constraintIndex = hardConstraints.length;

      hardConstraints.push({
        id: constraintId,
        name: '',
        type: 'option1',
        weight: 100
      });

      const cardDiv = document.createElement('div');
      cardDiv.className = 'card';
      cardDiv.id = constraintId;
      cardDiv.innerHTML = `
        <div class="grid">
          <div>
            <label>Constraint Name</label>
            <input type="text" placeholder="E.g., No back-to-back classes" 
              onchange="updateHardConstraint(${constraintIndex}, 'name', this.value)">
          </div>
          <div>
            <label>Type</label>
            <select onchange="updateHardConstraint(${constraintIndex}, 'type', this.value)">
              <option value="option1">Option 1</option>
              <option value="option2">Option 2</option>
              <option value="option3">Option 3</option>
            </select>
          </div>
          <div>
            <label>Weight</label>
            <input type="number" value="100" min="1" 
              onchange="updateHardConstraint(${constraintIndex}, 'weight', parseInt(this.value))">
          </div>
        </div>
        <button class="btn-remove" onclick="removeHardConstraint('${constraintId}', ${constraintIndex})">Remove</button>
      `;
      container.appendChild(cardDiv);
    }

    function updateHardConstraint(index, field, value) {
      if (hardConstraints[index]) {
        hardConstraints[index][field] = value;
      }
    }

    function removeHardConstraint(constraintId, index) {
      document.getElementById(constraintId).remove();
      hardConstraints.splice(index, 1);
    }

    // Soft Constraints
    function addSoftConstraint() {
      const container = document.getElementById("softConstraintsContainer");
      const constraintId = 'soft-' + Date.now();
      const constraintIndex = softConstraints.length;

      softConstraints.push({
        id: constraintId,
        name: '',
        type: 'option1',
        weight: 50
      });

      const cardDiv = document.createElement('div');
      cardDiv.className = 'card';
      cardDiv.id = constraintId;
      cardDiv.innerHTML = `
        <div class="grid">
          <div>
            <label>Constraint Name</label>
            <input type="text" placeholder="E.g., Prefer morning classes" 
              onchange="updateSoftConstraint(${constraintIndex}, 'name', this.value)">
          </div>
          <div>
            <label>Type</label>
            <select onchange="updateSoftConstraint(${constraintIndex}, 'type', this.value)">
              <option value="option1">Option 1</option>
              <option value="option2">Option 2</option>
              <option value="option3">Option 3</option>
            </select>
          </div>
          <div>
            <label>Weight</label>
            <input type="number" value="50" min="1" 
              onchange="updateSoftConstraint(${constraintIndex}, 'weight', parseInt(this.value))">
          </div>
        </div>
        <button class="btn-remove" onclick="removeSoftConstraint('${constraintId}', ${constraintIndex})">Remove</button>
      `;
      container.appendChild(cardDiv);
    }

    function updateSoftConstraint(index, field, value) {
      if (softConstraints[index]) {
        softConstraints[index][field] = value;
      }
    }

    function removeSoftConstraint(constraintId, index) {
      document.getElementById(constraintId).remove();
      softConstraints.splice(index, 1);
    }

    // Timetable functions
    function createPreviewTable(schedule) {
      const container = document.getElementById('previewContainer');
      let html = '<table><thead><tr><th>Day</th><th>Standard</th><th>Subject</th><th>Faculty</th><th>Classroom</th><th>Time</th></tr></thead><tbody>';

      Object.entries(schedule).forEach(([day, classes]) => {
        classes.forEach((cls, idx) => {
          html += `<tr>
            ${idx === 0 ? `<td rowspan="${classes.length}"><strong>${day}</strong></td>` : ''}
            <td>${cls.standard}</td>
            <td>${cls.course}</td>
            <td>${cls.faculty}</td>
            <td>${cls.classroom}</td>
            <td>${cls.startTime} - ${cls.endTime}</td>
          </tr>`;
        });
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function toggleMoreDetails() {
      const section = document.getElementById('moreDetailsSection');
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }

    function createStandardTimetables(schedule) {
      const container = document.getElementById('standardTimetablesContainer');
      let html = '';

      const allStandards = new Set();
      Object.values(schedule).forEach(dayClasses => {
        dayClasses.forEach(cls => allStandards.add(cls.standard));
      });

      Array.from(allStandards).forEach(standard => {
        const safeId = standard.replace(/\s+/g, '-').replace(/'/g, "");
        html += `<div style="margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 8px;">
          <h4>${standard}</h4>
          <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
            <button class="btn-secondary" onclick="createStandardTable('${standard}', '${standard.replace(/'/g, "\\'")}')" style="width: auto;">üìã Generate Table</button>
            <button class="btn-secondary" onclick="downloadStandardAsExcel('${standard}')" style="width: auto;">üì• Excel</button>
            <button class="btn-secondary" onclick="downloadStandardAsImage('${safeId}')" style="width: auto;">üñºÔ∏è Image</button>
          </div>
          <div id="table-${safeId}"></div>
        </div>`;
      });

      container.innerHTML = html || '<p>No standards found</p>';
    }

    function createStandardTable(standard, standardLabel) {
      const containerId = `table-${standard.replace(/\s+/g, '-').replace(/'/g, "")}`;
      const container = document.getElementById(containerId);

      if (!container) return;

      const allDays = Object.keys(currentScheduleData).sort((a, b) => {
        const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        return dayOrder.indexOf(a) - dayOrder.indexOf(b);
      });

      const allTimes = new Set();
      Object.values(currentScheduleData).forEach(dayClasses => {
        dayClasses.forEach(cls => {
          if (cls.standard === standard) {
            allTimes.add(cls.startTime);
          }
        });
      });

      const times = Array.from(allTimes).sort();

      let html = '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;"><thead><tr><th style="border: 1px solid #ddd; padding: 8px;">Time</th>';

      allDays.forEach(day => {
        html += `<th style="border: 1px solid #ddd; padding: 8px;">${day}</th>`;
      });

      html += '</tr></thead><tbody>';

      times.forEach(time => {
        html += `<tr><td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${time}</td>`;

        allDays.forEach(day => {
          const classAtTime = currentScheduleData[day]?.find(c =>
            c.standard === standard && c.startTime === time
          );

          const cellContent = classAtTime
            ? `<strong>${classAtTime.course}</strong><br>${classAtTime.faculty}<br>${classAtTime.classroom}`
            : '‚Äî';

          html += `<td style="border: 1px solid #ddd; padding: 8px; background: ${classAtTime ? '#fffacd' : '#fff'};">${cellContent}</td>`;
        });

        html += '</tr>';
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function downloadStandardAsExcel(standard) {
      if (!currentScheduleData) {
        showAlert('No timetable generated yet', 'error');
        return;
      }

      let csv = 'Time,';
      const allDays = Object.keys(currentScheduleData).sort();
      allDays.forEach(day => csv += `${day},`);
      csv += '\n';

      const allTimes = new Set();
      Object.values(currentScheduleData).forEach(dayClasses => {
        dayClasses.forEach(cls => {
          if (cls.standard === standard) {
            allTimes.add(cls.startTime);
          }
        });
      });

      const times = Array.from(allTimes).sort();
      times.forEach(time => {
        csv += `${time},`;
        allDays.forEach(day => {
          const classAtTime = currentScheduleData[day]?.find(c =>
            c.standard === standard && c.startTime === time
          );
          csv += `"${classAtTime ? `${classAtTime.course} - ${classAtTime.faculty}` : '‚Äî'}",`;
        });
        csv += '\n';
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${standard.replace(/\s+/g, '_')}_timetable.csv`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);

      showAlert(`${standard} timetable downloaded!`, 'success');
    }

    function downloadStandardAsImage(standardId) {
      const element = document.getElementById(`table-${standardId}`);
      if (!element || element.innerHTML.trim() === '') {
        showAlert('Please generate the table first', 'error');
        return;
      }

      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
      document.head.appendChild(script);

      script.onload = function () {
        html2canvas(element, { backgroundColor: '#ffffff' }).then(canvas => {
          const link = document.createElement('a');
          link.href = canvas.toDataURL('image/png');
          link.download = `${standardId}_timetable.png`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          showAlert('Image downloaded successfully!', 'success');
        });
      };
    }

    // Main timetable generation
    async function generateTimetable() {
      if (standards.length === 0 || standards.some(s => s.courses.length === 0)) {
        showAlert('Please add at least one standard with courses', 'error');
        return;
      }
      if (faculty.length === 0) {
        showAlert('Please add at least one faculty member', 'error');
        return;
      }
      if (assignments.length === 0) {
        showAlert('Please add at least one course assignment', 'error');
        return;
      }

      const classrooms = getClassrooms();
      if (classrooms.length === 0) {
        showAlert('Please add at least one classroom', 'error');
        return;
      }

      if (selectedDays.length === 0) {
        showAlert('Please select at least one day of the week', 'error');
        return;
      }

      const slots = collectTimeSlots();
      if (slots.length === 0) {
        showAlert('Please add at least one time slot', 'error');
        return;
      }

      document.getElementById('loadingIndicator').classList.add('active');
      document.getElementById('outputSection').style.display = 'none';

      try {
        const response = await fetch(`${API_BASE_URL}/api/generate-timetable`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            standards,
            faculty,
            assignments,
            classrooms,
            daysOfWeek: selectedDays,
            timeSlots: slots,
            hardConstraints,
            softConstraints
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to generate timetable');
        }

        generatedFilename = data.filename;
        currentScheduleData = data.data;

        document.getElementById('conflictCount').textContent = data.stats.conflicts;
        document.getElementById('fitnessScore').textContent = data.stats.fitness;
        document.getElementById('classCount').textContent = data.stats.classCount;

        createPreviewTable(data.data);
        createStandardTimetables(data.data);

        document.getElementById('outputSection').style.display = 'block';
        showAlert('Timetable generated successfully!', 'success');

      } catch (error) {
        showAlert('Error: ' + error.message, 'error');
        console.error(error);
      } finally {
        document.getElementById('loadingIndicator').classList.remove('active');
      }
    }

    function downloadExcel() {
      if (!generatedFilename) {
        showAlert('No timetable to download', 'error');
        return;
      }

      try {
        const link = document.createElement('a');
        link.href = `${API_BASE_URL}/output/${generatedFilename}`;
        link.download = generatedFilename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showAlert('File downloaded successfully!', 'success');
      } catch (error) {
        showAlert('Error downloading file: ' + error.message, 'error');
      }
    }

    function downloadAsImage() {
      const element = document.getElementById('previewContainer');
      if (!element) {
        showAlert('No timetable to download', 'error');
        return;
      }

      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
      document.head.appendChild(script);

      script.onload = function () {
        html2canvas(element, { backgroundColor: '#ffffff' }).then(canvas => {
          const link = document.createElement('a');
          link.href = canvas.toDataURL('image/png');
          link.download = `spacetime_timetable_${Date.now()}.png`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          showAlert('Image downloaded successfully!', 'success');
        });
      };
    }

    function resetForm() {
      if (confirm('Reset the entire form?')) {
        standards = [];
        faculty = [];
        assignments = [];
        selectedDays = [];
        generatedFilename = null;
        timeSlotValues = [{ startTime: '', endTime: '' }];
        hardConstraints = [];
        softConstraints = [];

        document.getElementById('standardsContainer').innerHTML = '';
        document.getElementById('facultyContainer').innerHTML = '';
        document.getElementById('roomContainer').innerHTML = '';
        document.getElementById('assignmentContainer').innerHTML = '';
        document.getElementById('hardConstraintsContainer').innerHTML = '';
        document.getElementById('softConstraintsContainer').innerHTML = '';
        document.querySelectorAll('#daysCheckboxes input').forEach(cb => cb.checked = false);

        renderTimeSlots();
        document.getElementById('outputSection').style.display = 'none';

        showAlert('Form reset successfully', 'info');
      }
    }

    // Initial setup
    renderTimeSlots();
  </script>
</body>

</html>